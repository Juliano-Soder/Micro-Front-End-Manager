<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Front-End Manager</title>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    /* Aplica a fonte Fira Code em todo o app */
    body {
      font-family: 'Fira Code', monospace;
      margin: 0;
      padding: 20px;
      background-color: #f4f4f4; /* Cor de fundo suave */
      color: #333; /* Cor do texto */
      max-width: 1200px; /* Limita a largura m√°xima */
      margin: 0 auto;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Modo Escuro */
    body.dark-mode {
      background-color: #1e1e1e;
      color: #ffffff;
    }

    h1, h2, h3, h4, h5, h6 {
      font-weight: 600;
      margin-bottom: 20px;
    }

     h1 {
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
      transition: border-color 0.3s ease;
    }

    body.dark-mode h1 {
      border-bottom-color: #555;
    }

    input, button {
      font-family: 'Fira Code', monospace;
    }

    button {
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background-color: #f0f0f0;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #e0e0e0;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Container para os controles principais */
    .main-controls {
      margin-bottom: 20px;
    }

    /* Estilos para MFEs containers */
    #pamp-mfes, #projects {
      margin-top: 15px;
    }

    /* Estilos para os cards de projeto */
    .project-card {
      position: relative;
      margin-bottom: 20px;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 5px;
      background-color: #fff; /* Fundo branco para os cards */
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    body.dark-mode .project-card {
      background-color: #2d2d2d;
      border-color: #555;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }



    /* Status indicators */
    #pinter-status {
      position: fixed;
      top: 10px;
      right: 10px;
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background: red;
      cursor: pointer;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }

    #status {
      position: fixed;
      top: 30px;
      right: 10px;
      max-width: 100px;
      height: 15px;
      font-size: 10px;
      cursor: pointer;
      padding: 2px 5px;
      border-radius: 2px;
    }

    /* Version info */
    .version-info {
      margin-top: 10px;
      margin-bottom: 20px;
    }

    /* Input com √≠cone de pasta */
    .input-with-folder {
      position: relative;
      display: block;
      width: 100%;
      box-sizing: border-box;
    }

    .folder-icon {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      cursor: pointer;
      z-index: 10;
      opacity: 0.7;
      transition: opacity 0.3s;
    }

    .folder-icon:hover {
      opacity: 1;
    }

    .folder-icon:disabled,
    .folder-icon.disabled {
      opacity: 0.3;
      cursor: not-allowed;
      pointer-events: none;
    }

    /* Ajusta o padding do input para dar espa√ßo ao √≠cone */
    .input-with-folder input {
      width: 100% !important;
      box-sizing: border-box !important;
      padding-right: 35px !important;
      padding-left: 8px !important;
      padding-top: 6px !important;
      padding-bottom: 6px !important;
      background-color: #ffffff;
      border: 1px solid #ccc;
      color: #333;
      transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
    }

    /* Estilos para inputs no modo escuro */
    body.dark-mode input {
      background-color: #3a3a3a;
      border-color: #555;
      color: #ffffff;
    }

    body.dark-mode input::placeholder {
      color: #aaa;
    }

    /* Console logs no modo escuro j√° est√£o com fundo preto, ent√£o mantemos eles */
    body.dark-mode div[id*="log-"] {
      background: #000 !important;
      color: #0f0 !important;
    }
  </style>
</head>
<body>
  <h1>
    Micro Front-Ends 
    <span id="node-version" style="font-size: 12px; margin-left: 10px; color: green;"></span>
    <span id="angular-version" style="font-size: 12px; margin-left: 10px; color: green;"></span>
    <span style="font-size: 10px; margin-left: 20px; color: #666; font-style: italic;" title="Atalhos para reiniciar">
      üí° Ctrl+R ou F5 = Reiniciar
    </span>
  </h1>
  
  <div class="version-info">
    <div id="node-warning" style="font-size: 12px; color: orange;"></div>
    <div id="angular-warning" style="font-size: 12px; color: orange;"></div>
  </div>

  <div id="pinter-status"></div>
  <div id="status" title="N√£o logado"></div>
  
  <div class="main-controls">
    <button id="toggle-mfes" style="margin-right: 10px;">&#9654; Mostrar MFEs do PAS</button>
    <button id="toggle-pamp-mfes">&#9654; Mostrar MFEs do PAMP</button>
  </div>
  
  <div id="pamp-mfes" style="display: none;"></div>
  <div id="projects" style="display: none;"></div>
  <script>
  const { ipcRenderer } = require('electron');

  const togglePampBtn = document.getElementById('toggle-pamp-mfes');
  const pampContainer = document.getElementById('pamp-mfes');
  let pampVisible = false;
  
  togglePampBtn.addEventListener('click', () => {
    pampVisible = !pampVisible;
    pampContainer.style.display = pampVisible ? 'block' : 'none';
    togglePampBtn.innerHTML = pampVisible ? '&#9660; Recolher MFEs do PAMP' : '&#9654; Mostrar MFEs do PAMP';
  });

  const toggleBtn = document.getElementById('toggle-mfes');
  const projectsContainer = document.getElementById('projects');
  let mfesVisible = false;
  
  toggleBtn.addEventListener('click', () => {
    mfesVisible = !mfesVisible;
    projectsContainer.style.display = mfesVisible ? 'block' : 'none';
    toggleBtn.innerHTML = mfesVisible ? '&#9660; Recolher MFEs do PAS' : '&#9654; Mostrar MFEs do PAS';
  });

  ipcRenderer.send('load-projects');

  // Carrega as configura√ß√µes (incluindo modo escuro)
  ipcRenderer.send('load-configs');
  
  // Fun√ß√£o para obter o √≠cone de terminal correto baseado no tema
  function getTerminalIcon() {
    const isDarkMode = document.body.classList.contains('dark-mode');
    return isDarkMode ? 'terminal_branco.png' : 'terminal.png';
  }

  // Fun√ß√£o para atualizar √≠cones de terminal baseado no tema
  function updateTerminalIcons() {
    const terminalIcon = getTerminalIcon();
    
    // Atualiza todos os √≠cones de terminal
    const terminalImages = document.querySelectorAll('img[id*="terminal"]');
    terminalImages.forEach(img => {
      if (img.src.includes('terminal.png') || img.src.includes('terminal_branco.png')) {
        img.src = terminalIcon;
      }
    });
  }
  
  // Recebe as configura√ß√µes e aplica o modo escuro se necess√°rio
  ipcRenderer.on('configs-loaded', (event, configs) => {
    if (configs.darkMode) {
      document.body.classList.add('dark-mode');
    }
    // Atualiza os √≠cones de terminal ap√≥s aplicar o tema
    updateTerminalIcons();
  });

  // Escuta mudan√ßas do modo escuro vindas da janela de configura√ß√µes
  ipcRenderer.on('apply-dark-mode', (event, isDarkMode) => {
    if (isDarkMode) {
      document.body.classList.add('dark-mode');
    } else {
      document.body.classList.remove('dark-mode');
    }
    // Atualiza os √≠cones de terminal ap√≥s mudan√ßa de tema
    updateTerminalIcons();
  });

  ipcRenderer.on('projects-loaded', (event, projects) => {

    // PAMP
    const pampProjects = projects.filter(p => p.name && p.name.startsWith('mp-pamp'));
    const pampContainer = document.getElementById('pamp-mfes');
    pampContainer.innerHTML = '';

  pampProjects.forEach((project, index) => {
      // Descubra o √≠ndice real no array projects
    const realIndex = projects.findIndex(p => p.name === project.name);
    const div = document.createElement('div');
    div.innerHTML = `
       <div class="project-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <p style="margin: 0;"><strong>${project.name}</strong></p>
          <img id="pamp-btn-terminal-${realIndex}" src="${getTerminalIcon()}" style="width: 24px; height: 24px; cursor: pointer; ${!project.path ? 'display: none' : ''}" title="Abrir terminal na pasta do projeto" alt="Terminal" />
        </div>
        <div class="input-with-folder" style="margin-bottom: 10px;">
          <input id="pamp-input-${realIndex}" data-path="${project.path}" type="text" value="${project.path}" placeholder="Insira o caminho do projeto" />
          <img id="pamp-folder-icon-${realIndex}" src="pasta.png" class="folder-icon" title="Procurar projeto existente" alt="Procurar pasta" />
        </div>
        <button id="pamp-btn-download-${realIndex}" style="margin-right: 10px; ${project.path ? 'display: none' : ''}">Baixar Projeto</button>
        <button id="pamp-btn-start-${realIndex}" style="margin-right: 10px;" ${!project.path ? 'disabled' : ''}>Iniciar</button>
        <button id="pamp-btn-cancel-${realIndex}" style="display: none; margin-right: 10px; background-color: #dc3545; color: white;" title="Cancelar inicializa√ß√£o">‚úï Cancelar</button>
        <button id="pamp-btn-stop-${realIndex}" style="display: none;">Parar</button>
        <button id="pamp-btn-move-${realIndex}" style="margin-right: 10px; ${!project.path ? 'display: none' : ''}; background-color: #007acc; color: white;">Mover para...</button>
        <button id="pamp-btn-delete-${realIndex}" style="margin-right: 10px; ${!project.path ? 'display: none' : ''}; background-color: red; color: white;">Deletar</button>
        <div id="pamp-log-${realIndex}" style="display: none; background: #000; color: #0f0; padding: 10px; height: 150px; overflow-y: auto; font-family: monospace; border-radius: 5px; margin-top: 10px;"></div>
      </div>
    `;
    pampContainer.appendChild(div);

    const pampInput = document.getElementById(`pamp-input-${realIndex}`);
    const pampDownloadButton = document.getElementById(`pamp-btn-download-${realIndex}`);
    const pampFolderIcon = document.getElementById(`pamp-folder-icon-${realIndex}`);
    const pampStartButton = document.getElementById(`pamp-btn-start-${realIndex}`);
    const pampCancelButton = document.getElementById(`pamp-btn-cancel-${realIndex}`);
    const pampStopButton = document.getElementById(`pamp-btn-stop-${realIndex}`);
    const pampTerminalButton = document.getElementById(`pamp-btn-terminal-${realIndex}`);
    const pampMoveButton = document.getElementById(`pamp-btn-move-${realIndex}`);
    const pampDeleteButton = document.getElementById(`pamp-btn-delete-${realIndex}`);
    const pampLogDiv = document.getElementById(`pamp-log-${realIndex}`);

    // Listener espec√≠fico para este projeto PAMP
    ipcRenderer.on('pamp-log', (event, { path, message, index, name, error, nodeVersionError }) => {
      // S√≥ processa se for para ESTE projeto espec√≠fico
      if (index !== realIndex) {
        return;
      }
      
      // Se for uma linha em branco, ignore
      if (!message.trim()) {
        return;
      }
      
      // Verifica se a mensagem √© igual √† √∫ltima mensagem adicionada
      if (pampLogDiv) {
        const currentText = pampLogDiv.innerText;
        const lines = currentText.split('\n');
        const lastLine = lines[lines.length - 1];
        
        // Se a mensagem for igual √† √∫ltima linha, ignore (exceto mensagens importantes)
        if (lastLine === message && 
            !message.includes('npm install') &&
            !message.includes('Compiled successfully')) {
          return;
        }
      }

      console.log(`Recebeu pamp-log: ${message} para √≠ndice ${index}`);
      
      if (pampLogDiv) {
        pampLogDiv.style.display = 'block';
        pampLogDiv.innerText += `\n${message}`;
        pampLogDiv.scrollTop = pampLogDiv.scrollHeight;
        
        if (message.includes('existe em')) {
          console.log('Mensagem cont√©m "existe em", tentando extrair caminho');
          try {
            const existingPath = path;
            console.log(`Caminho extra√≠do: ${existingPath}`);
            
            if (pampInput) {
              pampInput.value = existingPath;
              console.log(`Input atualizado com caminho: ${existingPath}`);
              
              if (pampDownloadButton) pampDownloadButton.style.display = 'none';
              if (pampStartButton) pampStartButton.disabled = false;
              if (pampDeleteButton) pampDeleteButton.style.display = 'inline-block';
              
              ipcRenderer.send('update-project-path', { index: realIndex, path: existingPath });
            }
          } catch (error) {
            console.error('Erro ao extrair caminho:', error);
          }
        }

        if (message.includes('terminou com c√≥digo') && message.includes('1')) {
          // Adiciona um aviso sobre a vers√£o do Node.js
          const nodeVersionSpan = document.getElementById('node-version');
          const currentNodeVersion = nodeVersionSpan.innerText.replace('Node.js: ', '');
          
          let warningMessage;
  
          if (currentNodeVersion === 'v16.10.0') {
            // Se a vers√£o √© correta, sugere verificar problemas de compila√ß√£o
            warningMessage = `\n\n‚ö†Ô∏è AVISO: O projeto apresentou erro de compila√ß√£o. 
            Verifique seu c√≥digo fonte por poss√≠veis problemas como:
            ‚Ä¢ Depend√™ncias incompat√≠veis
            ‚Ä¢ Erros de sintaxe
            ‚Ä¢ Problemas de configura√ß√£o
            ‚Ä¢ Comandos de shell n√£o dispon√≠veis (como 'sed')`;
          } else {
            // Se a vers√£o √© incorreta, mant√©m o aviso sobre a vers√£o do Node.js
            warningMessage = `\n\n‚ö†Ô∏è AVISO: O erro acima pode ser causado pela vers√£o incompat√≠vel do Node.js (${currentNodeVersion}).
            Projetos PAMP requerem Node.js v16.10.0. Por favor, instale a vers√£o correta para evitar erros de sintaxe.`;
          }
          
          if (pampLogDiv) {
            pampLogDiv.style.display = 'block';
            
            // Adicionar estilo para destacar o aviso
            pampLogDiv.innerHTML += `<div style="color: yellow; margin-top: 10px; border-top: 1px solid #444; padding-top: 10px;">${warningMessage}</div>`;
            pampLogDiv.scrollTop = pampLogDiv.scrollHeight;
          }
        }
        
        if (message.includes('Caminho do projeto:') || message.includes('Projeto baixado')) {
          if (pampDownloadButton) pampDownloadButton.style.display = 'none';
        }
      } else {
        console.error(`Elemento log n√£o encontrado para √≠ndice ${realIndex}`);
      }
    });

    pampInput.addEventListener('blur', () => {
      ipcRenderer.send('update-project-path', { index: realIndex, path: pampInput.value });
      if (pampInput.value.trim()) {
          pampDownloadButton.style.display = 'none';
          pampStartButton.disabled = false;
          pampMoveButton.style.display = 'inline-block';
          pampDeleteButton.style.display = 'inline-block';
      }else {
          pampDeleteButton.style.display = 'none';
          pampMoveButton.style.display = 'none';
          pampDownloadButton.style.display = 'inline-block';
          pampStartButton.disabled = true;
      }
    });

    pampDownloadButton.addEventListener('click', () => {
      pampFolderIcon.classList.add('disabled'); // Desabilita durante o download
      ipcRenderer.send('download-project', { name: project.name, index: realIndex });
    });

    pampFolderIcon.addEventListener('click', () => {
      ipcRenderer.send('browse-project-folder', { index: realIndex, projectName: project.name });
    });

    pampMoveButton.addEventListener('click', () => {
      if (pampInput.value.trim()) {
        // Verifica se o projeto est√° rodando
        if (pampStartButton.innerText === 'Rodando ‚úì') {
          alert('N√£o √© poss√≠vel mover o projeto enquanto ele estiver rodando. Pare o projeto primeiro.');
          return;
        }
        
        pampMoveButton.disabled = true;
        pampMoveButton.innerText = 'Movendo...';
        ipcRenderer.send('move-project', { 
          index: realIndex, 
          currentPath: pampInput.value, 
          projectName: project.name 
        });
      } else {
        alert('Projeto precisa ter um caminho v√°lido para ser movido.');
      }
    });

    pampDeleteButton.addEventListener('click', () => {
      if (confirm(`Tem certeza que deseja deletar o projeto ${project.name}?`)) {
        pampDeleteButton.disabled = true;
        pampFolderIcon.classList.add('disabled'); // Desabilita o √≠cone durante a dele√ß√£o
        ipcRenderer.send('delete-project', { index: realIndex, path: pampInput.value });
      }
    });

    pampStartButton.addEventListener('click', (event) => {
      pampStartButton.disabled = true;
      pampStartButton.innerText = 'Executando...';
      pampCancelButton.style.display = 'inline-block'; // Mostra bot√£o cancelar
      pampFolderIcon.classList.add('disabled'); // Desabilita durante a execu√ß√£o
      if (pampDeleteButton) pampDeleteButton.disabled = true;      
      ipcRenderer.send('start-project-pamp', { projectPath: pampInput.value, port: project.port });
    });

    pampCancelButton.addEventListener('click', () => {
      // Cancela o processo de inicializa√ß√£o
      ipcRenderer.send('cancel-project-startup', { projectPath: pampInput.value, isPamp: true, index: realIndex });
      
      // Restaura o estado dos bot√µes
      pampStartButton.disabled = false;
      pampStartButton.innerText = 'Iniciar';
      pampCancelButton.style.display = 'none';
      pampFolderIcon.classList.remove('disabled');
      if (pampDeleteButton) pampDeleteButton.disabled = false;
    });

    pampTerminalButton.addEventListener('click', () => {
      if (pampInput.value.trim()) {
        // Desabilita o √≠cone temporariamente para evitar cliques m√∫ltiplos
        pampTerminalButton.style.opacity = '0.5';
        pampTerminalButton.style.pointerEvents = 'none';
        pampTerminalButton.title = 'Abrindo terminal...';
        
        // Envia comando para abrir terminal
        ipcRenderer.send('open-terminal', { projectPath: pampInput.value });
        
        // Reabilita o √≠cone ap√≥s 5 segundos
        setTimeout(() => {
          pampTerminalButton.style.opacity = '1';
          pampTerminalButton.style.pointerEvents = 'auto';
          pampTerminalButton.title = 'Abrir terminal na pasta do projeto';
        }, 5000);
      } else {
        alert('Projeto precisa ter um caminho v√°lido para abrir o terminal.');
      }
    });

    pampStopButton.addEventListener('click', () => {
      ipcRenderer.send('stop-project', { projectPath: pampInput.value, port: project.port });
    });

  });  
    // FIM PAMP Projects

  // Listener global para logs de dele√ß√£o do PAMP (independente do √≠ndice)
  ipcRenderer.on('pamp-log', (event, { path, message, index, name, error, nodeVersionError }) => {
    // S√≥ processa mensagens de dele√ß√£o ou erro que n√£o foram capturadas pelos listeners espec√≠ficos
    if (message && (message.includes('Deletando') || message.includes('Erro ao deletar') || message.includes('deletado com sucesso') || message.includes('pode encontrar o arquivo especificado'))) {
      console.log(`Log global de dele√ß√£o PAMP: ${message} para √≠ndice ${index}`);
      
      const pampLogDiv = document.getElementById(`pamp-log-${index}`);
      if (pampLogDiv) {
        pampLogDiv.style.display = 'block';
        pampLogDiv.innerText += `\n${message}`;
        pampLogDiv.scrollTop = pampLogDiv.scrollHeight;
      } else {
        console.error(`Elemento log PAMP n√£o encontrado para √≠ndice ${index} (log global)`);
      }
    }
  });

  // Projects PAS
  const pasProjects = projects.filter(p => p.name && !p.name.startsWith('mp-pamp'));
  const container = document.getElementById('projects');
  container.innerHTML = '';

  pasProjects.forEach((project, pasIndex) => {
    // Descubra o √≠ndice real no array projects
    const realIndex = projects.findIndex(p => p.name === project.name);
    const div = document.createElement('div');
    div.innerHTML = `
      <div class="project-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <p style="margin: 0;"><strong>${project.name}</strong></p>
          <img id="btn-terminal-${realIndex}" src="${getTerminalIcon()}" style="width: 24px; height: 24px; cursor: pointer; ${!project.path ? 'display: none' : ''}" title="Abrir terminal na pasta do projeto" alt="Terminal" />
        </div>
        <div class="input-with-folder" style="margin-bottom: 10px;">
          <input id="input-${realIndex}" type="text" value="${project.path}" placeholder="Insira o caminho do projeto" />
          <img id="folder-icon-${realIndex}" src="pasta.png" class="folder-icon" title="Procurar projeto existente" alt="Procurar pasta" />
        </div>
        <button id="btn-download-${realIndex}" style="margin-right: 10px; ${project.path ? 'display: none' : ''}">Baixar Projeto</button>
        <button id="btn-start-${realIndex}" data-index="${realIndex}" style="margin-right: 10px;" ${!project.path ? 'disabled' : ''}>Iniciar</button>
        <button id="btn-cancel-${realIndex}" style="display: none; margin-right: 10px; background-color: #dc3545; color: white;" title="Cancelar inicializa√ß√£o">‚úï Cancelar</button>
        <button id="btn-stop-${realIndex}" style="display: none;">Parar</button>
        <button id="btn-move-${realIndex}" data-index="${realIndex}" style="margin-right: 10px; ${!project.path ? 'display: none' : ''}; background-color: #007acc; color: white;">Mover para...</button>
        <button id="btn-delete-${realIndex}" data-index="${realIndex}" style="margin-right: 10px; ${!project.path ? 'display: none' : ''}; background-color: red; color: white;">Deletar</button>
        <div id="log-${realIndex}" style="display: none; background: #000; color: #0f0; padding: 10px; height: 150px; overflow-y: auto; font-family: monospace; border-radius: 5px; margin-top: 10px;"></div>
      </div>
    `;
    container.appendChild(div);

    const input = document.getElementById(`input-${realIndex}`);
    const downloadButton = document.getElementById(`btn-download-${realIndex}`);
    const folderIcon = document.getElementById(`folder-icon-${realIndex}`);
    const startButton = document.getElementById(`btn-start-${realIndex}`);
    const cancelButton = document.getElementById(`btn-cancel-${realIndex}`);
    const stopButton = document.getElementById(`btn-stop-${realIndex}`);
    const terminalButton = document.getElementById(`btn-terminal-${realIndex}`);
    const moveButton = document.getElementById(`btn-move-${realIndex}`);
    const deleteButton = document.getElementById(`btn-delete-${realIndex}`);
    const logDiv = document.getElementById(`log-${realIndex}`);
  
    input.addEventListener('blur', () => {
      ipcRenderer.send('update-project-path', { index: realIndex, path: input.value });
      // Oculta o bot√£o "Baixar Projeto" se o path for preenchido
      if (input.value.trim()) {
          downloadButton.style.display = 'none';
          startButton.disabled = false;
          moveButton.style.display = 'inline-block';
          deleteButton.style.display = 'inline-block';
      }else {
        deleteButton.style.display = 'none';
        moveButton.style.display = 'none';
        downloadButton.style.display = 'inline-block';
      }
    });
  
    downloadButton.addEventListener('click', () => {
      ipcRenderer.send('download-project', { name: project.name, index: realIndex });
    });

    folderIcon.addEventListener('click', () => {
      ipcRenderer.send('browse-project-folder', { index: realIndex, projectName: project.name });
    });
  
    startButton.addEventListener('click', (event) => {
      startButton.disabled = true;
      startButton.innerText = 'Executando...';
      cancelButton.style.display = 'inline-block'; // Mostra bot√£o cancelar
      // Desabilite o bot√£o de delete correspondente
      const deleteButton = document.getElementById(`btn-delete-${event.currentTarget.getAttribute('data-index')}`);
      if (deleteButton) deleteButton.disabled = true;      
      ipcRenderer.send('start-project', { projectPath: input.value, port: project.port });
    });
  
    cancelButton.addEventListener('click', () => {
      // Cancela o processo de inicializa√ß√£o
      ipcRenderer.send('cancel-project-startup', { projectPath: input.value, isPamp: false, index: realIndex });
      
      // Restaura o estado dos bot√µes
      startButton.disabled = false;
      startButton.innerText = 'Iniciar';
      cancelButton.style.display = 'none';
      const deleteButton = document.getElementById(`btn-delete-${realIndex}`);
      if (deleteButton) deleteButton.disabled = false;
    });

    terminalButton.addEventListener('click', () => {
      if (input.value.trim()) {
        // Desabilita o √≠cone temporariamente para evitar cliques m√∫ltiplos
        terminalButton.style.opacity = '0.5';
        terminalButton.style.pointerEvents = 'none';
        terminalButton.title = 'Abrindo terminal...';
        
        // Envia comando para abrir terminal
        ipcRenderer.send('open-terminal', { projectPath: input.value });
        
        // Reabilita o √≠cone ap√≥s 5 segundos
        setTimeout(() => {
          terminalButton.style.opacity = '1';
          terminalButton.style.pointerEvents = 'auto';
          terminalButton.title = 'Abrir terminal na pasta do projeto';
        }, 5000);
      } else {
        alert('Projeto precisa ter um caminho v√°lido para abrir o terminal.');
      }
    });
  
    stopButton.addEventListener('click', () => {
      ipcRenderer.send('stop-project', { projectPath: input.value, port: project.port });
    });

    moveButton.addEventListener('click', () => {
      if (input.value.trim()) {
        // Verifica se o projeto est√° rodando
        if (startButton.innerText === 'Rodando ‚úì') {
          alert('N√£o √© poss√≠vel mover o projeto enquanto ele estiver rodando. Pare o projeto primeiro.');
          return;
        }
        
        moveButton.disabled = true;
        moveButton.innerText = 'Movendo...';
        ipcRenderer.send('move-project', { 
          index: realIndex, 
          currentPath: input.value, 
          projectName: project.name 
        });
      } else {
        alert('Projeto precisa ter um caminho v√°lido para ser movido.');
      }
    });

    deleteButton.addEventListener('click', () => {
      if (confirm(`Tem certeza que deseja deletar o projeto ${project.name}?`)) {
        deleteButton.disabled = true; // Desabilita o bot√£o durante a execu√ß√£o
        ipcRenderer.send('delete-project', { index: realIndex, path: input.value });
      }
    });
    
    ipcRenderer.on('delete-project-log', (event, { path, message, success }) => {
      const input = document.querySelector(`#projects input[value="${path}"]`);
      if (input) {
        const logDiv = input.nextElementSibling.nextElementSibling.nextElementSibling.nextElementSibling;
        const deleteButton = input.nextElementSibling.nextElementSibling;
        const startButton = input.nextElementSibling;
    
        logDiv.style.display = 'block';
        logDiv.innerText += `\n${message}`;
        logDiv.scrollTop = logDiv.scrollHeight;
    
        if (success) {
          input.value = ''; // Limpa o caminho do input
          window.location.reload();
        } else {
          deleteButton.disabled = false; // Reabilita o bot√£o em caso de erro
        }
      }
    });
  
    ipcRenderer.on('log', (event, { path, message }) => {
      if (project.path === path || message.includes(project.name)) {
          logDiv.style.display = 'block';
          logDiv.innerText += `\n${message}`;
          logDiv.scrollTop = logDiv.scrollHeight;

          // Oculta o bot√£o "Baixar Projeto" se o path for definido
          if (message.includes('Caminho do projeto:')) {
              downloadButton.style.display = 'none';
          }
      }
    });
    });
  });

  // Atualiza os √≠cones de terminal ap√≥s carregar projetos
  setTimeout(() => {
    updateTerminalIcons();
  }, 100);

  // Note: Drag and drop is initialized per card when created

  // Listeners globais movidos para fora do loop para evitar duplica√ß√£o
  
  // Listener para atualiza√ß√µes de status de projetos
  ipcRenderer.on('status-update', (event, { path, status, isPamp, index }) => {
    console.log(`*** FRONTEND STATUS UPDATE: path=${path}, status=${status}, isPamp=${isPamp}, index=${index}`);
    
    if (isPamp) {
      // Tratamento para projetos PAMP
      const pampStartButton = document.getElementById(`pamp-btn-start-${index}`);
      const pampCancelButton = document.getElementById(`pamp-btn-cancel-${index}`);
      const pampStopButton = document.getElementById(`pamp-btn-stop-${index}`);
      const pampMoveButton = document.getElementById(`pamp-btn-move-${index}`);
      const pampDeleteButton = document.getElementById(`pamp-btn-delete-${index}`);
      const pampFolderIcon = document.getElementById(`pamp-folder-icon-${index}`);
      
      console.log(`Atualizando status do projeto PAMP ${index} para ${status}`);
      
      if (status === 'running') {
        if (pampStartButton) {
          pampStartButton.innerText = 'Rodando ‚úì';
          pampStartButton.disabled = true;
          pampStartButton.style.backgroundColor = 'green';
          pampStartButton.style.color = 'white';
        }
        if (pampCancelButton) pampCancelButton.style.display = 'none'; // Esconde bot√£o cancelar
        if (pampMoveButton) pampMoveButton.style.display = 'none';
        if (pampDeleteButton) pampDeleteButton.style.display = 'none';
        if (pampStopButton) pampStopButton.style.display = 'inline-block';
        if (pampFolderIcon) pampFolderIcon.classList.add('disabled');
      } else if (status === 'stopping') {
        if (pampStopButton) {
          pampStopButton.innerText = 'Parando...';
          pampStopButton.disabled = true;
        }
        if (pampMoveButton) pampMoveButton.disabled = true;
        if (pampDeleteButton) pampDeleteButton.disabled = true;
        if (pampFolderIcon) pampFolderIcon.classList.add('disabled');
      } else if (status === 'stopped') {
        if (pampStartButton) {
          pampStartButton.innerText = 'Iniciar';
          pampStartButton.disabled = false;
          pampStartButton.style.backgroundColor = '';
          pampStartButton.style.color = '';
        }
        if (pampCancelButton) pampCancelButton.style.display = 'none'; // Esconde bot√£o cancelar
        if (pampStopButton) {
          pampStopButton.style.display = 'none';
          pampStopButton.disabled = false;
          pampStopButton.innerText = 'Parar';
        }
        if (pampMoveButton) {
          pampMoveButton.style.display = 'inline-block';
          pampMoveButton.disabled = false;
        }
        if (pampDeleteButton) {
          pampDeleteButton.style.display = 'inline-block';
          pampDeleteButton.disabled = false;
        }
        if (pampFolderIcon) pampFolderIcon.classList.remove('disabled');
      }
    } else {
      // Tratamento para projetos PAS
      // Usa o √≠ndice fornecido ou tenta encontrar pelo path como fallback
      let projectIndex = index;
      if (projectIndex === undefined || projectIndex === null) {
        projectIndex = projects.findIndex((project) => project.path === path);
      }
      
      if (projectIndex !== -1) {
        const startButton = document.getElementById(`btn-start-${projectIndex}`);
        const cancelButton = document.getElementById(`btn-cancel-${projectIndex}`);
        const stopButton = document.getElementById(`btn-stop-${projectIndex}`);
        const moveButton = document.getElementById(`btn-move-${projectIndex}`);
        const deleteButton = document.getElementById(`btn-delete-${projectIndex}`);

        if (status === 'running') {
          if (startButton) {
            startButton.innerText = 'Rodando ‚úì';
            startButton.disabled = true;
            startButton.style.backgroundColor = 'green';
            startButton.style.color = 'white';
          }
          if (cancelButton) cancelButton.style.display = 'none'; // Esconde bot√£o cancelar
          if (moveButton) moveButton.style.display = 'none';
          if (deleteButton) deleteButton.style.display = 'none';
          if (stopButton) stopButton.style.display = 'inline-block';
        } else if (status === 'stopping') {
          if (stopButton) {
            stopButton.innerText = 'Parando...';
            stopButton.disabled = true;
          }
          if (moveButton) moveButton.disabled = true;
          if (deleteButton) deleteButton.disabled = true;
        } else if (status === 'stopped') {
          if (startButton) {
            startButton.innerText = 'Iniciar';
            startButton.disabled = false;
            startButton.style.backgroundColor = '';
            startButton.style.color = 'black';
          }
          if (cancelButton) cancelButton.style.display = 'none'; // Esconde bot√£o cancelar
          if (stopButton) {
            stopButton.style.display = 'none';
            stopButton.disabled = false;
            stopButton.innerText = 'Parar';
          }
          if (moveButton) {
            moveButton.style.display = 'inline-block';
            moveButton.disabled = false;
          }
          if (deleteButton) {
            deleteButton.style.display = 'inline-block';
            deleteButton.disabled = false;
          }
        }
      }
    }
  });

  ipcRenderer.on('delete-project-log', (event, { path, message, success }) => {
    const input = document.querySelector(`#projects input[value="${path}"]`);
    if (input) {
      const logDiv = input.nextElementSibling.nextElementSibling.nextElementSibling.nextElementSibling;
      const deleteButton = input.nextElementSibling.nextElementSibling;
      const startButton = input.nextElementSibling;
  
      logDiv.style.display = 'block';
      logDiv.innerText += `\n${message}`;
      logDiv.scrollTop = logDiv.scrollHeight;
  
      if (success) {
        input.value = ''; // Limpa o caminho do input
        window.location.reload();
      } else {
        deleteButton.disabled = false; // Reabilita o bot√£o em caso de erro
      }
    }
  });

  // Listeners para o processo de mover projetos
  ipcRenderer.on('move-project-log', (event, { index, message, success }) => {
    // Tenta encontrar os elementos tanto para PAMP quanto para PAS
    const pampLogDiv = document.getElementById(`pamp-log-${index}`);
    const pampMoveButton = document.getElementById(`pamp-btn-move-${index}`);
    const logDiv = document.getElementById(`log-${index}`);
    const moveButton = document.getElementById(`btn-move-${index}`);
    
    // Prioriza elementos PAMP se existirem, caso contr√°rio usa PAS
    if (pampLogDiv && pampMoveButton) {
      // √â um projeto PAMP
      pampLogDiv.style.display = 'block';
      pampLogDiv.innerText += `\n${message}`;
      pampLogDiv.scrollTop = pampLogDiv.scrollHeight;
      
      pampMoveButton.disabled = false;
      pampMoveButton.innerText = 'Mover para...';
    } else if (logDiv && moveButton) {
      // √â um projeto PAS
      logDiv.style.display = 'block';
      logDiv.innerText += `\n${message}`;
      logDiv.scrollTop = logDiv.scrollHeight;
      
      moveButton.disabled = false;
      moveButton.innerText = 'Mover para...';
    }
  });

  ipcRenderer.on('update-project-path', (event, { index, path }) => {
    // Verifica se √© um projeto PAMP pelo √≠ndice
    const project = projects[index];
    const isPampProject = project && project.name && project.name.startsWith('mp-pamp');
    
    if (isPampProject) {
      const pampInput = document.getElementById(`pamp-input-${index}`);
      if (pampInput) {
        pampInput.value = path;
      } else {
        console.error(`Input PAMP n√£o encontrado para √≠ndice ${index}`);
      }
    } else {
      const input = document.getElementById(`input-${index}`);
      if (input) {
        input.value = path;
      } else {
        console.error(`Input PAS n√£o encontrado para √≠ndice ${index}`);
      }
    }
  });

  ipcRenderer.on('show-console', (event, { path, index, isPamp }) => {
    if (isPamp) {
      const pampLogDiv = document.getElementById(`pamp-log-${index}`);
      if (pampLogDiv) {
        pampLogDiv.style.display = 'block';
      }
    } else {
      const projectIndex = projects.findIndex((project) => project.path === path);
      if (projectIndex !== -1) {
        const logDiv = document.getElementById(`log-${projectIndex}`);
        if (logDiv) {
          logDiv.style.display = 'block';
        }
      }
    }
  });

  ipcRenderer.on('delete-project-log', (event, { path, message, success, index }) => {
    const console = document.getElementById(`pamp-log-${index}`);
    
    // Sempre exibe a mensagem de log primeiro
    if (console && message) {
      console.style.display = 'block';
      console.innerText += `\n${message}`;
      console.scrollTop = console.scrollHeight;
    }
    
    if(message.includes('pode encontrar o arquivo especificado')) {
      // Em caso de erro, reabilita o bot√£o deletar e o √≠cone
      const deleteBtn = document.getElementById(`pamp-btn-delete-${index}`);
      const pampFolderIcon = document.getElementById(`pamp-folder-icon-${index}`);
      if (deleteBtn) deleteBtn.disabled = false;
      if (pampFolderIcon) pampFolderIcon.classList.remove('disabled');
      return;
    }
    
     if (success) {
      // Use querySelector para buscar os elementos mesmo que n√£o existam vari√°veis de refer√™ncia
      const deleteBtn = document.getElementById(`pamp-btn-delete-${index}`);
      const moveBtn = document.getElementById(`pamp-btn-move-${index}`);
      const downloadBtn = document.getElementById(`pamp-btn-download-${index}`);
      const startBtn = document.getElementById(`pamp-btn-start-${index}`);
      const stopBtn = document.getElementById(`pamp-btn-stop-${index}`);
      const pampInput = document.getElementById(`pamp-input-${index}`);
      const pampFolderIcon = document.getElementById(`pamp-folder-icon-${index}`);
      
      if (deleteBtn) deleteBtn.style.display = 'none';
      if (moveBtn) moveBtn.style.display = 'none';
      if (downloadBtn) downloadBtn.style.display = 'inline-block';
      if (startBtn) {
        startBtn.style.display = 'inline-block';
        startBtn.disabled = true;
      }
      if (stopBtn) stopBtn.style.display = 'none';
      if (pampInput) {
        pampInput.value = '';
      }
      if (pampFolderIcon) pampFolderIcon.classList.remove('disabled');
      
      setTimeout(() => {
        if (console) {
          console.innerText = ''; // Limpa o conte√∫do
          console.style.display = 'none';
        }
      }, 2000); // Aumentei para 2 segundos para dar tempo de ler
    } else {
      const deleteBtn = document.getElementById(`pamp-btn-delete-${index}`);
      if (deleteBtn) deleteBtn.disabled = false;
    }
    });

  // Atualiza o status de login
  ipcRenderer.on('log', (event, { message }) => {
      const statusDiv = document.getElementById('status');
      if (message.includes('Logado no Nexus com sucesso')) {
        statusDiv.innerText = 'Logado no Nexus ‚úì';
        statusDiv.style.background = 'green';
      } else if (message.includes('Erro no login')) {
        statusDiv.innerText = 'Erro no login ‚úó';
        statusDiv.style.background = 'red';
      }
  });

  ipcRenderer.send('load-login-state');

  ipcRenderer.on('login-state', (event, isLoggedIn) => {
    const statusDiv = document.getElementById('status');
    const pinterStatusDiv = document.getElementById('pinter-status');
    pinterStatusDiv.style.background = isLoggedIn ? 'green' : 'red';
    if (isLoggedIn) {
      statusDiv.innerText = 'Logado no Nexus ‚úì';
    } else {
      statusDiv.innerText = 'N√£o logado';
    }
  });

  ipcRenderer.send('load-node-info');
  ipcRenderer.send('load-angular-info');
  ipcRenderer.on('node-info', (event, { version, warning }) => {
    const nodeVersionSpan = document.getElementById('node-version');
    const nodeWarningDiv = document.getElementById('node-warning');

    if (version) {
      nodeVersionSpan.innerText = `Node.js: ${version}`;
      nodeVersionSpan.style.color = version === 'v16.10.0' ? 'green' : 'orange';
    } else {
      nodeVersionSpan.innerHTML = `<a href="https://nodejs.org/" target="_blank" style="color: red; text-decoration: none;">Node.js n√£o instalado (Baixar)</a>`;
    }

    if (warning) {
      nodeWarningDiv.innerText = warning;
    } else {
      nodeWarningDiv.innerText = '';
    }
  });

  ipcRenderer.on('angular-info', (event, { version, warning }) => {
    const angularVersionSpan = document.getElementById('angular-version');
    const angularWarningDiv = document.getElementById('angular-warning');

    if (version) {
      angularVersionSpan.innerText = `Angular CLI: ${version}`;
      angularVersionSpan.style.color = version === '13.3.11' ? 'green' : 'orange';
    } else {
      angularVersionSpan.innerHTML = `<a href="https://angular.io/cli" target="_blank" style="color: red; text-decoration: none;">Angular CLI n√£o instalado (Baixar)</a>`;
    }

    if (warning) {
      angularWarningDiv.innerText = warning;
    } else {
      angularWarningDiv.innerText = '';
    }
  });

  ipcRenderer.on('update-project', (event, { index, path }) => {
    // Verifica se √© um projeto PAMP pelo √≠ndice no array de projetos
    const project = projects[index];
    const isPampProject = project && project.name && project.name.startsWith('mp-pamp');
    
    if(isPampProject) {
      const pampInput = document.getElementById(`pamp-input-${index}`);
      const pampMoveButton = document.getElementById(`pamp-btn-move-${index}`);
      const pampDeleteButton = document.getElementById(`pamp-btn-delete-${index}`);
      const pampDownloadButton = document.getElementById(`pamp-btn-download-${index}`);
      const pampFolderIcon = document.getElementById(`pamp-folder-icon-${index}`);
  
      // Atualiza o valor do input e os bot√µes relacionados ao projeto deletado
      pampInput.value = path;
      pampInput.disabled = false;
      pampMoveButton.style.display = 'none'; // Oculta o bot√£o "Mover para..."
      pampDeleteButton.style.display = 'none'; // Oculta o bot√£o "Deletar"
      pampDownloadButton.style.display = 'inline-block'; // Reexibe o bot√£o "Baixar Projeto"
      if (pampFolderIcon) pampFolderIcon.classList.remove('disabled'); // Habilita o √≠cone da pasta
    }else {
      const input = document.getElementById(`input-${index}`);
      const moveButton = document.getElementById(`btn-move-${index}`);
      const deleteButton = document.getElementById(`btn-delete-${index}`);
      const browseButton = document.getElementById(`btn-browse-${index}`);
      const downloadButton = document.getElementById(`btn-download-${index}`);
    
      // Atualiza o valor do input e os bot√µes relacionados ao projeto deletado
      input.value = path;
      input.disabled = false;
      moveButton.style.display = 'none'; // Oculta o bot√£o "Mover para..."
      deleteButton.style.display = 'none'; // Oculta o bot√£o "Deletar"
      browseButton.style.display = 'inline-block'; // Reexibe o bot√£o "Procurar"
      downloadButton.style.display = 'inline-block'; // Reexibe o bot√£o "Baixar Projeto"
    }
  });
  
  // Para projetos PAMP
  ipcRenderer.on('pamp-process-error', (event, { path, index }) => {
    console.log(`Projeto PAMP com erro, resetando bot√µes para √≠ndice ${index}`);
    const pampStartButton = document.getElementById(`pamp-btn-start-${index}`);
    const pampCancelButton = document.getElementById(`pamp-btn-cancel-${index}`);
    const pampDeleteButton = document.getElementById(`pamp-btn-delete-${index}`);
    const pampFolderIcon = document.getElementById(`pamp-folder-icon-${index}`);
    
    if (pampStartButton) {
      pampStartButton.disabled = false;
      pampStartButton.innerText = 'Iniciar';
    }
    
    if (pampCancelButton) {
      pampCancelButton.style.display = 'none'; // Esconde bot√£o cancelar
    }
    
    if (pampDeleteButton) {
      pampDeleteButton.disabled = false;
      pampDeleteButton.style.display = 'inline-block';
    }
    
    if (pampFolderIcon) {
      pampFolderIcon.classList.remove('disabled');
    }
  });
  
  // Para projetos PAS
  ipcRenderer.on('process-error', (event, { path }) => {
    // Encontre o projeto pelo caminho
    const projectIndex = projects.findIndex(p => p.path === path);
    if (projectIndex !== -1) {
      const startButton = document.getElementById(`btn-start-${projectIndex}`);
      const cancelButton = document.getElementById(`btn-cancel-${projectIndex}`);
      const deleteButton = document.getElementById(`btn-delete-${projectIndex}`);
      
      if (startButton) {
        startButton.disabled = false;
        startButton.innerText = 'Iniciar';
        startButton.style.backgroundColor = '';
        startButton.style.color = 'black';
      }
      
      if (cancelButton) {
        cancelButton.style.display = 'none'; // Esconde bot√£o cancelar
      }
      
      if (deleteButton) {
        deleteButton.disabled = false;
        deleteButton.style.display = 'inline-block';
      }
    }
  });

  // Handler para resposta do browse de projeto
  ipcRenderer.on('project-path-selected', (event, { index, path, projectName }) => {
    console.log(`Recebida resposta do browse: projeto ${projectName}, √≠ndice ${index}, caminho ${path}`);
    
    // Atualiza o input correspondente
    const pampInput = document.getElementById(`pamp-input-${index}`);
    const pasInput = document.getElementById(`input-${index}`);
    
    if (pampInput) {
      pampInput.value = path;
      
      // Atualiza os bot√µes da se√ß√£o PAMP
      const pampDownloadButton = document.getElementById(`pamp-btn-download-${index}`);
      const pampStartButton = document.getElementById(`pamp-btn-start-${index}`);
      const pampMoveButton = document.getElementById(`pamp-btn-move-${index}`);
      const pampDeleteButton = document.getElementById(`pamp-btn-delete-${index}`);
      
      if (pampDownloadButton) pampDownloadButton.style.display = 'none';
      if (pampStartButton) pampStartButton.disabled = false;
      if (pampMoveButton) pampMoveButton.style.display = 'inline-block';
      if (pampDeleteButton) pampDeleteButton.style.display = 'inline-block';
    }
    
    if (pasInput) {
      pasInput.value = path;
      
      // Atualiza os bot√µes da se√ß√£o PAS
      const downloadButton = document.getElementById(`btn-download-${index}`);
      const startButton = document.getElementById(`btn-start-${index}`);
      const moveButton = document.getElementById(`btn-move-${index}`);
      const deleteButton = document.getElementById(`btn-delete-${index}`);
      
      if (downloadButton) downloadButton.style.display = 'none';
      if (startButton) startButton.disabled = false;
      if (moveButton) moveButton.style.display = 'inline-block';
      if (deleteButton) deleteButton.style.display = 'inline-block';
    }
    
    // Envia a atualiza√ß√£o para o backend
    ipcRenderer.send('update-project-path', { index: index, path: path });
  });

  // Handler para verifica√ß√£o manual do status do Nexus
  ipcRenderer.on('check-nexus-status', () => {
    ipcRenderer.send('check-nexus-status');
  });

  // Drag and Drop functionality
  function initializeDragAndDropForCard(card, isPamp) {
    if (!card) return;
    
    const projectName = card.querySelector('strong').textContent.trim();
    const isRootProject = projectName.includes('root');
    
    if (isRootProject) {
      // Projects with "root" cannot be dragged
      card.classList.add('fixed-position');
      return;
    }

    // Make draggable
    card.classList.add('draggable');
    card.draggable = true;
    
    // Add drag event listeners
    card.addEventListener('dragstart', handleDragStart);
    card.addEventListener('dragend', handleDragEnd);
  }

  function initializeDragAndDrop() {
    setupDragAndDrop('projects', false); // PAS projects
    setupDragAndDrop('pamp-mfes', true); // PAMP projects
  }

  function setupDragAndDrop(containerId, isPamp) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const projectCards = container.querySelectorAll('.project-card');
    
    projectCards.forEach((card) => {
      initializeDragAndDropForCard(card, isPamp);
    });
    
    // Add container event listeners for better drop handling
    container.addEventListener('dragover', handleContainerDragOver);
    container.addEventListener('drop', handleContainerDrop);
  }

  let draggedElement = null;
  let draggedProjectName = null;
  let sourceContainer = null;
  let dragStartY = 0;

  function handleDragStart(e) {
    draggedElement = e.currentTarget;
    draggedProjectName = draggedElement.querySelector('strong').textContent.trim();
    sourceContainer = draggedElement.closest('#projects, #pamp-mfes');
    
    // Store initial mouse position
    dragStartY = e.clientY;
    
    draggedElement.classList.add('dragging');
    
    // Set drag data
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', draggedElement.outerHTML);
    
    console.log(`Iniciando drag de: ${draggedProjectName}`);
  }

  function handleDragEnd(e) {
    if (draggedElement) {
      draggedElement.classList.remove('dragging');
      console.log(`Finalizando drag de: ${draggedProjectName}`);
      
      // Reset variables
      draggedElement = null;
      draggedProjectName = null;
      sourceContainer = null;
      dragStartY = 0;
    }
    
    // Remove all visual indicators
    document.querySelectorAll('.project-card.drag-over, .project-card.drag-above, .project-card.drag-below').forEach(card => {
      card.classList.remove('drag-over', 'drag-above', 'drag-below');
    });
  }

  function handleContainerDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    
    if (!draggedElement) return;
    
    // Find the closest card to the mouse position
    const container = e.currentTarget;
    const afterElement = getDragAfterElement(container, e.clientY);
    const cards = Array.from(container.querySelectorAll('.project-card:not(.dragging)'));
    
    // Remove previous indicators
    cards.forEach(card => {
      card.classList.remove('drag-above', 'drag-below');
    });
    
    if (afterElement == null) {
      // Dragging at the end
      const lastCard = cards[cards.length - 1];
      if (lastCard && !lastCard.querySelector('strong').textContent.includes('root')) {
        lastCard.classList.add('drag-below');
      }
    } else {
      // Dragging before another element
      if (!afterElement.querySelector('strong').textContent.includes('root')) {
        afterElement.classList.add('drag-above');
      }
    }
  }

  function handleContainerDrop(e) {
    e.preventDefault();
    
    if (!draggedElement) return;
    
    const container = e.currentTarget;
    const afterElement = getDragAfterElement(container, e.clientY);
    
    console.log('Drop detectado no container, afterElement:', afterElement?.querySelector('strong')?.textContent || 'null');
    
    // Only allow reordering within the same type (PAS with PAS, PAMP with PAMP)
    if (sourceContainer !== container) {
      console.log('Tentativa de mover entre containers diferentes - cancelado');
      return;
    }
    
    // Insert the dragged element at the correct position
    if (afterElement == null) {
      // Insert at the end
      container.appendChild(draggedElement);
      console.log('Elemento movido para o final');
    } else {
      // Insert before the afterElement
      container.insertBefore(draggedElement, afterElement);
      console.log('Elemento movido antes de:', afterElement.querySelector('strong').textContent);
    }
    
    // Update project order array
    updateProjectOrder(container);
  }

  function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.project-card:not(.dragging):not(.fixed-position)')];
    
    return draggableElements.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      
      if (offset < 0 && offset > closest.offset) {
        return { offset: offset, element: child };
      } else {
        return closest;
      }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }

  function updateProjectOrder(container) {
    const projectOrder = [];
    const isPamp = container.id === 'pamp-mfes';
    
    // Get all project names in the new order (excluding ROOT projects)
    const reorderedCards = Array.from(container.querySelectorAll('.project-card'));
    reorderedCards.forEach(card => {
      const projectName = card.querySelector('strong').textContent.trim();
      if (!projectName.includes('root')) {
        projectOrder.push(projectName);
      }
    });

    console.log(`Ordem atualizada para ${isPamp ? 'PAMP' : 'PAS'}:`, projectOrder);
    
    // Save the new order
    ipcRenderer.send('save-project-order', { 
      projectOrder: projectOrder, 
      isPamp: isPamp 
    });
  }
</script>
</body>
</html>